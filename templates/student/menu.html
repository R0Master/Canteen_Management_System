{% extends "base.html" %}
{% block content %}

<div id="menu-calendar"></div>

<form id="dateForm" method="get" style="display:none;">
  <input type="hidden" name="date" id="dateInput" value="{{ selected_date.isoformat() }}">
</form>

<div class="d-flex flex-wrap gap-3 align-items-center mt-3 small text-muted" id="menu-legend">
  <div class="d-flex align-items-center gap-2">
    <span class="menu-legend-box menu-legend-available"></span>
    <span>можно выбрать</span>
  </div>

  <div class="d-flex align-items-center gap-2">
    <span class="menu-legend-box menu-legend-ordered"></span>
    <span>заказ уже оформлен</span>
  </div>

  <div class="d-flex align-items-center gap-2">
    <span class="menu-legend-box menu-legend-disabled"></span>
    <span>недоступно</span>
  </div>

  <div class="d-flex align-items-center gap-2">
    <span class="menu-legend-box menu-legend-today"></span>
    <span>сегодня</span>
  </div>

  <div class="d-flex align-items-center gap-2">
    <span class="menu-legend-box menu-legend-selected"></span>
    <span>выбрано</span>
  </div>
</div>

<h2 class="mt-3">Меню на {{ selected_date.strftime("%d.%m.%Y") }}</h2>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const enabledDates = new Set({{ enabled_dates_json|safe }});
    const orderedDates = new Set({{ ordered_dates_json|safe }});
    const dayStatus = {{ day_status_json|safe }}; // { "YYYY-MM-DD": "issued"|"paid"|"created" }

    const selectedIso = "{{ selected_date.isoformat() }}";

    const calendarEl = document.getElementById('menu-calendar');
    if (!calendarEl) return;

    function isWeekend(date) {
      const day = date.getDay(); // 0=Sun,6=Sat
      return day === 0 || day === 6;
    }

    function pad2(n) { return String(n).padStart(2, '0'); }

    function localISO(date) {
      const y = date.getFullYear();
      const m = pad2(date.getMonth() + 1);
      const d = pad2(date.getDate());
      return `${y}-${m}-${d}`;
    }

    function addLabel(cellEl, text, color) {
      // Вставляем не в td, а во внутренний frame (это важно)
      const frame = cellEl.querySelector('.fc-daygrid-day-frame') || cellEl;

      // убираем старую подпись при перерисовке
      const old = frame.querySelector('.day-status-label');
      if (old) old.remove();

      // делаем frame позиционируемым
      frame.style.position = 'relative';

      const label = document.createElement('div');
      label.className = 'day-status-label';
      label.textContent = text;

      // Центр ячейки, без влияния на сетку
      label.style.position = 'absolute';
      label.style.left = '50%';
      label.style.top = '60%'; // чуть ниже заголовка дня
      label.style.transform = 'translate(-50%, -50%)';
      label.style.width = '92%';
      label.style.textAlign = 'center';

      label.style.fontSize = '0.75em';
      label.style.fontWeight = '500';
      label.style.lineHeight = '1.15';
      label.style.color = color || '#6c757d';
      label.style.pointerEvents = 'none';
      label.style.whiteSpace = 'nowrap';
      label.style.overflow = 'hidden';
      label.style.textOverflow = 'ellipsis';

      frame.appendChild(label);
    }


    const calendar = new FullCalendar.Calendar(calendarEl, {
      locale: 'ru',
      initialView: 'dayGridWeek',
      firstDay: 1,
      height: 'auto',
      showNonCurrentDates: false,

      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: ''
      },

      initialDate: "{{ first_selectable_date or selected_date.isoformat() }}",

      dateClick: function(info) {
        const dIso = info.dateStr; // YYYY-MM-DD без сдвигов

        const d = new Date(info.date);
        d.setHours(0,0,0,0);

        const today = new Date();
        today.setHours(0,0,0,0);

        if (d < today) return;
        if (isWeekend(d)) return;
        if (!enabledDates.has(dIso)) return;

        // запрещаем клик только если заказ уже выдан
        const st = dayStatus[dIso]; // issued | paid | created | undefined
        if (st === "issued") return;

        const form = document.getElementById('dateForm');
        const input = document.getElementById('dateInput');
        input.value = dIso;
        form.submit();
      },

      dayCellDidMount: function(arg) {
        const d = new Date(arg.date);
        d.setHours(0,0,0,0);
        const dIso = localISO(d);

        const today = new Date();
        today.setHours(0,0,0,0);
        const todayIso = localISO(today);

        const isPast = d < today;
        const weekend = isWeekend(d);
        const hasMenu = enabledDates.has(dIso);

        const status = dayStatus[dIso]; // issued | paid | created | undefined

        // --- базовый вид ---
        arg.el.style.borderRadius = '8px';
        arg.el.style.cursor = 'default';
        arg.el.style.outline = '';
        arg.el.style.outlineOffset = '';
        arg.el.style.backgroundColor = '';
        arg.el.style.opacity = '1';


        if (dIso === selectedIso) {
          arg.el.style.outline = '3px solid #0d6efd';
          arg.el.style.outlineOffset = '-3px';
        } else if (dIso === todayIso) {
          arg.el.style.outline = '2px dashed rgba(13,110,253,0.85)';
          arg.el.style.outlineOffset = '-2px';
        }

        let labelText = '';
        let labelColor = '#6c757d';

        if (status === 'issued') {
          labelText = 'выдано';
          labelColor = '#198754';
        } else if (status === 'paid') {
          labelText = 'оплачено';
          labelColor = '#198754';
        } else if (status === 'created') {
          labelText = 'ожидает оплаты';
        } else {
          if (isPast) {
            labelText = 'нет заказа';
          } else {
            if (!weekend && hasMenu) labelText = 'сделать заказ';
            else labelText = 'меню недоступно';
          }
        }

        if (isPast || weekend || !hasMenu) {
          arg.el.style.opacity = '0.35';
          arg.el.style.cursor = 'not-allowed';
          addLabel(arg.el, labelText, labelColor);
          return;
        }

        if (status === 'issued' || status === 'paid') {
          arg.el.style.backgroundColor = '#d1e7dd';
          arg.el.style.cursor = 'not-allowed';
        } else if (status === 'created') {
          arg.el.style.backgroundColor = '#fff3cd';
          arg.el.style.cursor = 'pointer';
        } else {
          arg.el.style.backgroundColor = '#fff3cd';
          arg.el.style.cursor = 'pointer';
        }

        addLabel(arg.el, labelText, labelColor);
      }
    });

    calendar.render();
  });
</script>

<hr>

{% if not locked %}
  <div id="menu-page">

    {% set meal_type = "BREAKFAST" %}
    {% include "student/_meal_block.html" %}

    {% set meal_type = "LUNCH" %}
    {% include "student/_meal_block.html" %}

    <hr>

    <div id="menu-summary">
      {% include "student/_summary.html" %}
    </div>

  </div>
{% else %}
  {# если заказ уже создан (CREATED/PAID/ISSUED) — показываем только summary #}
  <div id="menu-summary">
    {% include "student/_summary.html" %}
  </div>
{% endif %}

{% endblock %}
